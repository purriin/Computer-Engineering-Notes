- Mail Transfer Protocols
	- SMTP
	- POP3
	- IMAP4

## 8.1 E-mail
- 3 major components:
	1. User agents
	2. Mail servers
	3. Simple mail transfer protocol: SMTP

**User Agent**
- A.k.a. "mail reader"
- Composing, editing, reading mail messages
- Ex. Outlook, iPhone mail client
- Outgoing, incoming messages stored on server

**Mail Servers**:
- *Mailbox* contains incoming messages for user
- *Message Queue* of outgoing (to be sent) mail messages
- *SMTP Protocol* between mail servers to send email messages
	- Client: Sending mail server
	- "Server": Receiving mail server

### 8.1.1 The RFC
- Uses TCP to reliably transfer email messages from the client (mail server initiating connection) to the server, port 25
- Direct transfer: sending server (acting like a client) to receiving server
- 3 phases of transfer
	1. Handshaking (greeting)
	2. Transfer of messages 
	3. Closure
- Command/response interaction (like HTTP) 
	- Commands: ASCII text
	- Response: status code and phrase
- Messages must be in 7-bit ASCI

### 8.1.2 Scenario: Alice sends e-mail to Bob
1. Alice uses UA to compose e-mail message "to" bob@someschool.edu
2. Alice's UA sends message to her mail server; message place in message queue
3. Client side of SMTP opens TCP connection with Bob's mail server
4. SMTP client sends Alice's message over the TCP connection
5. Bob's mail server places the message in Bob's mailbox
6. Bob invokes his user agent to read message

**Sample SMTP Interaction**:
```
S: 220 hamburger.edu
C: HELO crepes.fr 
S: 250 Hello crepes.fr, pleased to meet you 
C: MAIL FROM: <alice@crepes.fr>
S: 250 alice@crepes.fr... Sender ok 
C: RCPT TO: <bob@hamburger.edu>
S: 250 bob@hamburger.edu ... Recipient ok 
C: DATA 
S: 354 Enter mail, end with "." on a line by itself
C: Do you like ketchup? 
C: How about pickles? 
C: . 
S: 250 Message accepted for delivery C
: QUIT 
S: 221 hamburger.edu closing connection
```

**Try SMTP Interaction for Yourself**:
`telnet <servername> 25`
- See 220 reply from server 
- Enter HELO, MAIL FROM:, RCPT TO:, DATA, QUIT commands
- Above lets you send email without using e-mail client (reader) 
- Note: this will only work if allows telnet connections to port 25 (this is becoming increasingly rare because of security concerns)

## 8.2 SMTP: Closing Observations
**Comparison with HTTP**:
- HTTP: Pull
- SMTP: Push
- Both have ASCII command/response interaction, status codes
- HTTP: Each object encapsulated in its own response message
- SMTP: Multiple objects sent in multipart message
- SMTP uses persistent connections
- SMTP requires message (header & body) to be in 7-bit ASCII
- SMTP server uses CRLF.CRLF to determine end of message

- Q: What happens if the mail message has a single dot in a line?
	- Ans: SMTP will add another dot to the single dot

## 8.3 Mail Message Format
**SMTP**: Protocol for exchanging e-mail messages, defined in RFC 531 (like HTTP)
- RFC 822 defines *syntax* for e-mail message itself (like HTML)
- Header Lines, e.g.,
	- To:
	- From:
	- Subject
	- These lines, within the body of the email message area different from SMTP MAIL FROM:, RCPT TO: commands!
- Body: The "message", ASCII characters only

## 8.4 Mail Access Protocols
**SMTP**: Delivery/storage of e-mail messages to receiver's server

**Mail Access Protocol**: Retrieval from server
- **IMAP**: Internet Mail Access Protocol \[RFC 3501]: Messages stored on server, IMAP provides retrieval, deletion, folders of stored messages on server

**HTTP**: Gmail, Hotmail, Yahoo!Mail, etc. provides web-based interface on top of STMP (to send), IMAP or POP to retrieve e-mail messages

### 8.4.1 Post Office Protocol (POP)
- Uses TCP to retrieve email from a remote server on port 110 
- Current version: 3 $\rightarrow$ POP3
- Encrypted communication (POP3S) is done via SSL on TCP port 995
- Supports “download-and-delete”
- Has an option to leave the email on the server
- Emails are identified by “message-number” local to that session.

1. Authorization Phase
	- Client commands:
		- `user`: declare username
		- `pass`: password
	- Server responses:
		- `+OK`
		- `-ERR`
2. Transaction Phase
	- `list`: list message numbers
	- `retr`: retrieve message by number
	- `dele`: delete
	- `quit`

### 8.4.2 Internet Message Access Protocol (IMAP)
- Current version 4
- Listens on port 143
- Emails are left on the server until the user deletes them
- Allows concurrent access with multiple clients
- Clients can have multiple mailboxes/folders
- Server-side search on emails possible
- IMAP permits downloading only the message header $\rightarrow$ useful for mobile devices

### 8.4.3 POP3 and IMAP
| POP3 | IMAP |
| ---- | ---- |
| Previous example uses "download and delete" mode | Keep all messages in one place: the server |
| Bob cannot re-read email if he changes client | Allows user to organize messages in folders |
| "Download-and-keep": copies of messages on different clients | IMAP keeps user state across sessions:<br>Names of folders and mappings between message IDs and folder name |
| POP3 is stateless across sessions |  |
- Consider the following two statements :
	1. Email clients may use either SMTP or POP3 to send and receive emails.
	2. SMTP uses 7-bit ASCII messages over a TCP connection to send emails.
	- Statement 2 is true but statement 1 is false
	  
### 8.4.4 Multipurpose Internet Mail Extension (MIME)
- MIME is a supplementary protocol that allows non-ASCII data to be sent through SMTP
	- Ex. Sending an image
- MIME is **not** a mail protocol and cannot replace SMTP

## 8.5 Important Concepts
- Two different protocols are required in email: SMTP + {pop, imap, http}
- SMTP transmits the content in ASCII (not secure)
- SMTP is a push protocol (unlike http)
- Unlike http, in SMTP multiple objects are sent in multipart messages
- The last line in SMTP has a single dot (.)

- Compare POP and IMAP
- IMAP builds folders to maintain emails on server
- MIME changes a binary file into ASCII.
- Multiple objects can be encapsulated together in a MIME format.